<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoja SRD 5.2.1</title>
    <script src="https://unpkg.com/@owlbear-rodeo/sdk@latest/dist/obr.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c2f33; color: white; padding: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #23272a; padding: 5px; border-radius: 5px; text-align: center; border: 1px solid #7289da; }
        .stat-box label { font-size: 0.7rem; color: #99aab5; display: block; text-transform: uppercase; }
        input { width: 80%; background: transparent; border: none; border-bottom: 1px solid #7289da; color: white; text-align: center; font-size: 1.2rem; }
        textarea { width: 100%; background: #23272a; color: white; border: 1px solid #444; border-radius: 4px; height: 80px; resize: none; }
        h3 { border-bottom: 2px solid #7289da; padding-bottom: 5px; font-size: 1rem; }
        #token-name { font-weight: bold; color: #7289da; }
    </style>
</head>
<body>

    <div id="no-selection">Selecciona un token para ver su hoja.</div>

    <div id="sheet" style="display: none;">
        <h3>Hoja de: <span id="token-name"></span></h3>
        
        <div class="grid">
            <div class="stat-box"><label>Fuerza</label><input type="number" id="str" data-key="stats.str"></div>
            <div class="stat-box"><label>Destreza</label><input type="number" id="dex" data-key="stats.dex"></div>
            <div class="stat-box"><label>Constitución</label><input type="number" id="con" data-key="stats.con"></div>
            <div class="stat-box"><label>Inteligencia</label><input type="number" id="int" data-key="stats.int"></div>
            <div class="stat-box"><label>Sabiduría</label><input type="number" id="wis" data-key="stats.wis"></div>
            <div class="stat-box"><label>Carisma</label><input type="number" id="cha" data-key="stats.cha"></div>
        </div>

        <div class="grid">
            <div class="stat-box"><label>Vida (PG)</label><input type="number" id="hp" data-key="hp"></div>
            <div class="stat-box"><label>CA</label><input type="number" id="ac" data-key="ac"></div>
            <div class="stat-box"><label>Iniciativa</label><input type="number" id="init" data-key="init"></div>
        </div>

        <h3>Rasgos y Equipo</h3>
        <textarea id="notes" data-key="notes" placeholder="Escribe aquí los rasgos del SRD o equipo..."></textarea>
    </div>

    <script>
        const ID_EXTENS_METADATA = "com.mi-hoja-srd.data";
        let currentTokenId = null;

        OBR.onReady(async () => {
            // 1. Detectar cambios en la selección
            OBR.player.onChange((player) => {
                const selection = player.selection;
                if (selection && selection.length > 0) {
                    setupSheet(selection[0]);
                } else {
                    document.getElementById('sheet').style.display = 'none';
                    document.getElementById('no-selection').style.display = 'block';
                }
            });
        });

        async function setupSheet(tokenId) {
            currentTokenId = tokenId;
            const items = await OBR.scene.items.getItems([tokenId]);
            const token = items[0];

            if (!token) return;

            document.getElementById('sheet').style.display = 'block';
            document.getElementById('no-selection').style.display = 'none';
            document.getElementById('token-name').innerText = token.name;

            // Cargar datos guardados en el token
            const metadata = token.metadata[ID_EXTENS_METADATA] || {};
            
            // Llenar los inputs con los datos del metadata
            document.querySelectorAll('input, textarea').forEach(el => {
                const key = el.getAttribute('data-key');
                el.value = getNestedValue(metadata, key) || "";
            });
        }

        // Guardar datos al cambiar cualquier input
        document.addEventListener('input', async (e) => {
            if (!currentTokenId || !e.target.dataset.key) return;

            const key = e.target.dataset.key;
            const value = e.target.value;

            await OBR.scene.items.updateItems([currentTokenId], (items) => {
                for (let item of items) {
                    if (!item.metadata[ID_EXTENS_METADATA]) item.metadata[ID_EXTENS_METADATA] = {};
                    setNestedValue(item.metadata[ID_EXTENS_METADATA], key, value);
                }
            });
        });

        // Funciones auxiliares para manejar objetos anidados (ej: stats.str)
        function getNestedValue(obj, path) {
            return path.split('.').reduce((prev, curr) => prev && prev[curr], obj);
        }

        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            const lastKey = keys.pop();
            const lastObj = keys.reduce((prev, curr) => prev[curr] = prev[curr] || {}, obj);
            lastObj[lastKey] = value;
        }
    </script>
</body>
</html>
